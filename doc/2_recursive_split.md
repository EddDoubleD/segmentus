---
jupyter:
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
  language_info:
    codemirror_mode:
      name: ipython
      version: 2
    file_extension: .py
    mimetype: text/x-python
    name: python
    nbconvert_exporter: python
    pygments_lexer: ipython2
    version: 2.7.6
  nbformat: 4
  nbformat_minor: 5
---

::: {#2ffcf1031a9a6965 .cell .markdown}
# Рекурсивная нарезка текста на чанки с использованием LangChain

В данном Jupyter-блокноте мы исследуем метод рекурсивной нарезки текста
с помощью класса RecursiveCharacterTextSplitter из библиотеки LangChain.
Этот метод позволяет эффективно разделить текст на смысловые единицы,
такие как абзацы и предложения, сохраняя при этом их семантическую
целостность. Рекурсивная нарезка особенно полезна в случаях, когда
необходимо максимально учитывать контекстуальные и структурные границы
текста для последующих задач обработки естественного языка.
:::

::: {#6a02d4124525b8d2 .cell .markdown}
## Базовый пример рекурсивной нарезки текста

В данном примере используется текст Конституции Российской Федерации.
:::

::: {#c30e062bdc978d20 .cell .code execution_count="6" ExecuteTime="{\"end_time\":\"2024-05-12T20:24:36.817579Z\",\"start_time\":\"2024-05-12T20:24:36.815049Z\"}"}
``` python
file_path = 'constitutionrf.txt'
with open(file_path, 'r', encoding='utf-8') as file:
    text = file.read()
```
:::

::: {#b456c2a6925e4fb4 .cell .markdown}
Создадим объект класса `RecursiveCharacterTextSplitter` и далее
передадим на вход метода create_documents массив из текстовых
документов, после чего отобразим статистическую информацию.
:::

::: {#initial_id .cell .code execution_count="7" ExecuteTime="{\"end_time\":\"2024-05-12T20:24:36.843530Z\",\"start_time\":\"2024-05-12T20:24:36.818761Z\"}"}
``` python
from langchain_text_splitters import RecursiveCharacterTextSplitter

text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=200,
    chunk_overlap=20,
    length_function=len,
    is_separator_regex=False,
)

chunks = text_splitter.create_documents([text])

print(f"Всего чанков: {len(chunks)}")
print("Первые N чанков:")
chunks[:10]
```

::: {.output .stream .stdout}
    Всего чанков: 998
    Первые N чанков:
:::

::: {.output .execute_result execution_count="7"}
    [Document(page_content='\ufeffКОНСТИТУЦИЯ РОССИЙСКОЙ ФЕДЕРАЦИИ'),
     Document(page_content='Мы, многонациональный народ Российской Федерации,\nсоединенные общей судьбой на своей земле,\nутверждая права и свободы человека, гражданский мир и согласие,'),
     Document(page_content='сохраняя исторически сложившееся государственное единство,\nисходя из общепризнанных принципов равноправия и самоопределения народов,'),
     Document(page_content='чтя память предков, передавших нам любовь и уважение к Отечеству, веру в добро и справедливость,\nвозрождая суверенную государственность России и утверждая незыблемость ее демократической основы,'),
     Document(page_content='стремясь обеспечить благополучие и процветание России,\nисходя из ответственности за свою Родину перед нынешним и будущими поколениями,\nсознавая себя частью мирового сообщества,'),
     Document(page_content='принимаем КОНСТИТУЦИЮ РОССИЙСКОЙ ФЕДЕРАЦИИ.'),
     Document(page_content='РАЗДЕЛ ПЕРВЫЙ\n\nГЛАВА 1.\nОСНОВЫ КОНСТИТУЦИОННОГО СТРОЯ\n\nСтатья 1'),
     Document(page_content='Статья 1\n\n1. Российская Федерация - Россия есть демократическое федеративное правовое государство с республиканской формой правления.\n2. Наименования Российская Федерация и Россия равнозначны.'),
     Document(page_content='Статья 2\n\nЧеловек, его права и свободы являются высшей ценностью. Признание, соблюдение и защита прав и свобод человека и гражданина - обязанность государства.\n\nСтатья 3'),
     Document(page_content='1. Носителем суверенитета и единственным источником власти в Российской Федерации является ее многонациональный народ.')]
:::
:::

::: {#15d4e258980260ea .cell .markdown}
## Нарезка текста состоящего из иероглифов

А в данном примере мы через параметр `separators` заменим разделители
текста по умолчанию на CJK разделители.
:::

::: {#c5882fe0933a5ae .cell .code execution_count="8" ExecuteTime="{\"end_time\":\"2024-05-12T20:24:36.863298Z\",\"start_time\":\"2024-05-12T20:24:36.844462Z\"}"}
``` python
text_splitter = RecursiveCharacterTextSplitter(
    separators=[
        "\n\n", "\n", " ", ".", ",",
        "\u200b",  # Zero-width space
        "\uff0c",  # Fullwidth comma
        "\u3001",  # Ideographic comma
        "\uff0e",  # Fullwidth full stop
        "\u3002",  # Ideographic full stop
        ""  # Последний элемент в списке пытается делить текст на максимально маленькие части
    ],
    chunk_size=200,
    chunk_overlap=20
)

chunks = text_splitter.create_documents([text])

print(f"Всего чанков: {len(chunks)}")
print("Первые N чанков:")
chunks[:10]
```

::: {.output .stream .stdout}
    Всего чанков: 998
    Первые N чанков:
:::

::: {.output .execute_result execution_count="8"}
    [Document(page_content='\ufeffКОНСТИТУЦИЯ РОССИЙСКОЙ ФЕДЕРАЦИИ'),
     Document(page_content='Мы, многонациональный народ Российской Федерации,\nсоединенные общей судьбой на своей земле,\nутверждая права и свободы человека, гражданский мир и согласие,'),
     Document(page_content='сохраняя исторически сложившееся государственное единство,\nисходя из общепризнанных принципов равноправия и самоопределения народов,'),
     Document(page_content='чтя память предков, передавших нам любовь и уважение к Отечеству, веру в добро и справедливость,\nвозрождая суверенную государственность России и утверждая незыблемость ее демократической основы,'),
     Document(page_content='стремясь обеспечить благополучие и процветание России,\nисходя из ответственности за свою Родину перед нынешним и будущими поколениями,\nсознавая себя частью мирового сообщества,'),
     Document(page_content='принимаем КОНСТИТУЦИЮ РОССИЙСКОЙ ФЕДЕРАЦИИ.'),
     Document(page_content='РАЗДЕЛ ПЕРВЫЙ\n\nГЛАВА 1.\nОСНОВЫ КОНСТИТУЦИОННОГО СТРОЯ\n\nСтатья 1'),
     Document(page_content='Статья 1\n\n1. Российская Федерация - Россия есть демократическое федеративное правовое государство с республиканской формой правления.\n2. Наименования Российская Федерация и Россия равнозначны.'),
     Document(page_content='Статья 2\n\nЧеловек, его права и свободы являются высшей ценностью. Признание, соблюдение и защита прав и свобод человека и гражданина - обязанность государства.\n\nСтатья 3'),
     Document(page_content='1. Носителем суверенитета и единственным источником власти в Российской Федерации является ее многонациональный народ.')]
:::
:::

::: {#5335d5993ba7d784 .cell .markdown}
## Рекурсивная нарезка JSON документов

В данном примере мы нарежем JSON-файл имеющий структуру описанную
стандартом OpenAPI.
:::

::: {#cbbade4f1d25b20f .cell .code execution_count="9" ExecuteTime="{\"end_time\":\"2024-05-12T20:24:37.408975Z\",\"start_time\":\"2024-05-12T20:24:36.863957Z\"}"}
``` python
import requests

json_url = "https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/examples/v3.0/uspto.json"
json_data = requests.get(json_url).json()
```
:::

::: {#8fb7b4a34237f4e2 .cell .code execution_count="10" ExecuteTime="{\"end_time\":\"2024-05-12T20:24:37.413688Z\",\"start_time\":\"2024-05-12T20:24:37.410104Z\"}"}
``` python
from langchain_text_splitters import RecursiveJsonSplitter

json_splitter = RecursiveJsonSplitter(max_chunk_size=300)
json_chunks = json_splitter.split_json(json_data=json_data)

print(f"Всего чанков: {len(json_chunks)}")
print("Первые N чанков:")
chunks[:10]
```

::: {.output .stream .stdout}
    Всего чанков: 58
    Первые N чанков:
:::

::: {.output .execute_result execution_count="10"}
    [Document(page_content='\ufeffКОНСТИТУЦИЯ РОССИЙСКОЙ ФЕДЕРАЦИИ'),
     Document(page_content='Мы, многонациональный народ Российской Федерации,\nсоединенные общей судьбой на своей земле,\nутверждая права и свободы человека, гражданский мир и согласие,'),
     Document(page_content='сохраняя исторически сложившееся государственное единство,\nисходя из общепризнанных принципов равноправия и самоопределения народов,'),
     Document(page_content='чтя память предков, передавших нам любовь и уважение к Отечеству, веру в добро и справедливость,\nвозрождая суверенную государственность России и утверждая незыблемость ее демократической основы,'),
     Document(page_content='стремясь обеспечить благополучие и процветание России,\nисходя из ответственности за свою Родину перед нынешним и будущими поколениями,\nсознавая себя частью мирового сообщества,'),
     Document(page_content='принимаем КОНСТИТУЦИЮ РОССИЙСКОЙ ФЕДЕРАЦИИ.'),
     Document(page_content='РАЗДЕЛ ПЕРВЫЙ\n\nГЛАВА 1.\nОСНОВЫ КОНСТИТУЦИОННОГО СТРОЯ\n\nСтатья 1'),
     Document(page_content='Статья 1\n\n1. Российская Федерация - Россия есть демократическое федеративное правовое государство с республиканской формой правления.\n2. Наименования Российская Федерация и Россия равнозначны.'),
     Document(page_content='Статья 2\n\nЧеловек, его права и свободы являются высшей ценностью. Признание, соблюдение и защита прав и свобод человека и гражданина - обязанность государства.\n\nСтатья 3'),
     Document(page_content='1. Носителем суверенитета и единственным источником власти в Российской Федерации является ее многонациональный народ.')]
:::
:::
